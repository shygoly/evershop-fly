name: Deploy new EverShop instance

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "New Fly.io app name (e.g. evershop-fly-branch1)"
        required: true
        type: string
      shop_name:
        description: "Display name of the shop"
        required: true
        type: string
      admin_email:
        description: "Admin email (stored as secret on the app)"
        required: true
        type: string
      admin_password:
        description: "Admin password (stored as secret on the app)"
        required: true
        type: string
      image:
        description: "Docker image to deploy (default: registry.fly.io/evershop-fly:deployment-01KB443273PJVSTHG1X6DJ4GE1 from evershop-fly-test112903). If empty, will use default. If set, build is skipped and this image is used."
        required: false
        type: string
        default: "registry.fly.io/evershop-fly:deployment-01KB443273PJVSTHG1X6DJ4GE1"
      org_slug:
        description: "Fly organization slug to create the app under (overrides FLY_ORG_SLUG secret)."
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      FLYCTL_ACCESS_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Setup Wrangler CLI
        run: |
          npm config set fetch-timeout 120000
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
          npm install -g wrangler

      - name: Verify R2 bucket exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          wrangler r2 bucket list || echo "⚠️ Warning: Cannot list R2 buckets (wrangler may not be authenticated)"

      - name: Authenticate flyctl
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.fly
          TOK="${FLY_API_TOKEN:-${FLYCTL_ACCESS_TOKEN:-${FLY_ACCESS_TOKEN:-}}}"
          if [ -z "$TOK" ]; then echo "::error::Missing Fly API token in secrets"; exit 1; fi
          printf '%s' "$TOK" > ~/.fly/access_token
          chmod 600 ~/.fly/access_token

      - name: Create app if not exists
        shell: bash
        run: |
          set -euo pipefail
          APP_IN="${{ inputs.app_name }}"
          APP="$APP_IN"
          ORG_SLUG_INPUT="${{ inputs.org_slug }}"
          ORG_SLUG_SECRET="${{ secrets.FLY_ORG_SLUG }}"
          ORG_SLUG="$ORG_SLUG_INPUT"
          if [ -z "$ORG_SLUG" ]; then ORG_SLUG="$ORG_SLUG_SECRET"; fi
          if [ -z "$ORG_SLUG" ]; then
            echo "No org_slug input/secret; discovering first available org via flyctl orgs list"
            ORG_SLUG=$(flyctl orgs list --json | node -e '
              let d="";process.stdin.on("data",c=>d+=c);
              process.stdin.on("end",()=>{try{let j=JSON.parse(d);if(Array.isArray(j)&&j.length)console.log(j[0].slug);else console.log("")}catch(e){console.log("")}});
            ')
          fi
          if [ -z "$ORG_SLUG" ]; then
            echo "::error::Could not determine Fly org slug. Set inputs.org_slug or secrets.FLY_ORG_SLUG"
            exit 1
          fi
          echo "Using Fly org: $ORG_SLUG"

          # Try create; if name taken globally, auto-suffix and retry
          set +e
          CREATE_OUT=$(flyctl apps create "$APP" -o "$ORG_SLUG" 2>&1)
          CREATE_CODE=$?
          set -e
          if [ $CREATE_CODE -ne 0 ]; then
            echo "$CREATE_OUT"
            if echo "$CREATE_OUT" | grep -qi "Name has already been taken"; then
              SUF=$(openssl rand -hex 3 | head -c 6)
              APP="${APP_IN}-${SUF}"
              echo "App name taken. Retrying with: $APP"
              flyctl apps create "$APP" -o "$ORG_SLUG"
            else
              echo "::error::Failed to create app"
              exit 1
            fi
          fi
          echo "APP_NAME=$APP" >> "$GITHUB_ENV"
          echo "App to use: $APP"

      - name: Configure secrets (DB/R2 shared, shop/admin customized)
        shell: bash
        run: |
          set -euo pipefail
          APP="${APP_NAME:-${{ inputs.app_name }}}"
          
          # Sanitize Schema name: replace hyphens with underscores
          DB_SCHEMA=$(echo "$APP" | tr '-' '_')
          
          NODE_CONFIG_JSON=$(printf '%s' '{"shop":{"name":"'"${{ inputs.shop_name }}"'"}}')
          # optional shared secrets
          add_secret() {
            local key="$1"; local value="$2"
            if [ -n "$value" ]; then
              SET_ARGS+=("$key=$value")
            fi
          }

          declare -a SET_ARGS=()
          add_secret "DATABASE_URL" '${{ secrets.DATABASE_URL }}'
          add_secret "AWS_ACCESS_KEY_ID" '${{ secrets.AWS_ACCESS_KEY_ID }}'
          add_secret "AWS_SECRET_ACCESS_KEY" '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          add_secret "AWS_REGION" '${{ secrets.AWS_REGION }}'
          add_secret "AWS_BUCKET_NAME" '${{ secrets.AWS_BUCKET_NAME }}'
          add_secret "AWS_ENDPOINT_URL_S3" '${{ secrets.AWS_ENDPOINT_URL_S3 }}'
          add_secret "PUBLIC_ASSET_BASE_URL" '${{ secrets.PUBLIC_ASSET_BASE_URL }}'
          add_secret "S3_FORCE_PATH_STYLE" "true"
          add_secret "DB_HOST" '${{ secrets.DB_HOST }}'
          add_secret "DB_PORT" '${{ secrets.DB_PORT }}'
          add_secret "DB_NAME" '${{ secrets.DB_NAME }}'
          add_secret "DB_USER" '${{ secrets.DB_USER }}'
          add_secret "DB_PASSWORD" '${{ secrets.DB_PASSWORD }}'
          add_secret "DB_SCHEMA" "$DB_SCHEMA"
          add_secret "NODE_CONFIG" "$NODE_CONFIG_JSON"
          add_secret "ADMIN_EMAIL" '${{ inputs.admin_email }}'
          add_secret "ADMIN_PASSWORD" '${{ inputs.admin_password }}'

          if [ ${#SET_ARGS[@]} -gt 0 ]; then
            flyctl secrets set "${SET_ARGS[@]}" -a "$APP"
          fi

      - name: Deploy to Fly.io (prebuilt image if provided)
        shell: bash
        run: |
          set -euo pipefail
          APP="${APP_NAME:-${{ inputs.app_name }}}"
          IMG="${{ inputs.image }}"
          # Use provided image or fallback to default
          if [ -z "$IMG" ]; then
            IMG="registry.fly.io/evershop-fly:deployment-01KB443273PJVSTHG1X6DJ4GE1"
          fi
          echo "Deploying with image: $IMG"
          flyctl deploy -a "$APP" -i "$IMG"

      - name: Dump Fly logs on failure
        if: ${{ failure() }}
        shell: bash
        run: |
          set -euo pipefail
          APP="${APP_NAME:-${{ inputs.app_name }}}"
          echo "--- Machines list ($APP) ---"
          flyctl machines list -a "$APP" || true
          MID=$(flyctl machines list -a "$APP" --json | node -e '
            let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{try{let j=JSON.parse(d);if(Array.isArray(j)&&j.length)console.log(j[0].id);else console.log("")}catch(e){console.log("")}});
          ' || true)
          echo "--- Recent app logs ($APP) (buffered) ---"
          flyctl logs -a "$APP" --no-tail || true
          if [ -n "$MID" ]; then
            echo "--- Machine $MID logs ($APP) (buffered) ---"
            flyctl logs -a "$APP" --machine "$MID" --no-tail || true
          fi

      - name: Create admin user
        shell: bash
        run: |
          set -euo pipefail
          APP="${APP_NAME:-${{ inputs.app_name }}}"
          
          # Sanitize Schema name: replace hyphens with underscores
          DB_SCHEMA=$(echo "$APP" | tr '-' '_')
          
          # Try official CLI if present, fallback to node cli.js path
          ADMIN_NAME="${{ inputs.shop_name }} Owner"
          flyctl ssh console -a "$APP" -C "sh -lc 'set -e; export DB_SCHEMA=\"$DB_SCHEMA\"; echo \"Using DB_SCHEMA: \$DB_SCHEMA\"; NAME=\"${ADMIN_NAME}\"; if command -v evershop >/dev/null 2>&1; then evershop user:create --name \"\$NAME\" --email \"${{ inputs.admin_email }}\" --password \"${{ inputs.admin_password }}\" --role admin; else node /app/node_modules/@evershop/evershop/bin/evershop user:create --name \"\$NAME\" --email \"${{ inputs.admin_email }}\" --password \"${{ inputs.admin_password }}\" --role admin; fi'"

      - name: Output
        run: |
          APP="${APP_NAME:-${{ inputs.app_name }}}"
          echo "App: $APP deployed."
          echo "Visit: https://$APP.fly.dev"
